<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hours History - Timesheet</title>
    <link rel="stylesheet" href="/styles.css" />
    <script src="/userMenu.js" defer></script>
    <style>
      .date-range-form {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex-wrap: wrap;
        margin-bottom: 1rem;
        padding: 1rem;
        background: #f9fafb;
        border-radius: 0.5rem;
      }
      .date-range-form label {
        font-weight: 500;
        font-size: 0.9rem;
      }
      .date-range-form input[type="date"] {
        padding: 0.5rem;
        border-radius: 0.5rem;
        border: 1px solid #d1d5db;
        font-size: 0.9rem;
      }
      .quick-filters {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-top: 0.5rem;
      }
      .quick-filters .btn {
        font-size: 0.85rem;
        padding: 0.4rem 0.8rem;
      }
      @media (max-width: 640px) {
        .date-range-form {
          display: grid;
          grid-template-columns: 1fr;
          align-items: start;
        }
        .date-range-form label,
        .date-range-form input[type="date"],
        .date-range-form .btn {
          width: 100%;
        }
        .quick-filters {
          display: grid;
          grid-template-columns: 1fr 1fr;
        }
      }
    </style>
  </head>
  <body>
    <header class="topbar">
      <div class="brand"><%= brand %></div>
      <% if (user) { %>
        <div class="topbar-nav">
          <button onclick="window.history.back()" class="btn btn-nav">‚Üê Back</button>
          <a href="/dashboard" class="btn btn-nav">Home</a>
        </div>
        <div class="topbar-right">
          <div class="user-menu">
            <button type="button" class="user-menu-trigger" id="user-menu-trigger" aria-haspopup="menu" aria-expanded="false" aria-label="User menu">
              <svg viewBox="0 0 24 24" width="24" height="24">
                <circle class="circle" cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"></circle>
                <circle class="head" cx="12" cy="8" r="3" fill="currentColor"></circle>
                <path class="body" d="M12 13 Q 8 13 7 16 Q 12 18 17 16 Q 16 13 12 13" fill="currentColor"></path>
              </svg>
            </button>
            <div class="user-menu-panel" id="user-menu-panel" role="menu" aria-hidden="true">
              <div class="user-menu-header">
                <div class="user-name"><%= user.name %><% if (user.is_admin) { %> (Admin)<% } %></div>
                <% if (typeof user.email !== 'undefined' && user.email) { %>
                  <div class="user-email"><%= user.email %></div>
                <% } %>
              </div>
              <div class="user-menu-actions">
                <div class="user-menu-section">
                  <div class="section-label">Theme</div>
                  <div class="theme-options" role="group" aria-label="Theme">
                    <button type="button" class="menu-item" role="menuitemradio" data-theme-option="dark" aria-checked="false">Dark</button>
                    <button type="button" class="menu-item" role="menuitemradio" data-theme-option="light" aria-checked="true">Light</button>
                    <button type="button" class="menu-item" role="menuitemradio" data-theme-option="system" aria-checked="false">System</button>
                  </div>
                </div>
                <div class="menu-divider" aria-hidden="true"></div>
                <form method="post" action="/logout">
                  <button type="submit" class="menu-item" role="menuitem">Log out</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      <% } %>
    </header>

    <main class="container">
      <section class="card hours-history">
        <h1>Hours History</h1>
        
        <% if (typeof errorMessage !== 'undefined' && errorMessage) { %>
          <div class="alert"><%= errorMessage %></div>
        <% } %>
        
        <form method="get" action="/hours" class="date-range-form" onsubmit="return validateDateRange()">
          <label for="startDate">From:</label>
          <input type="date" id="startDate" name="startDate" value="<%= (typeof startDate !== 'undefined' && startDate) ? startDate : '' %>" required />
          
          <label for="endDate">To:</label>
          <input type="date" id="endDate" name="endDate" value="<%= (typeof endDate !== 'undefined' && endDate) ? endDate : '' %>" required />
          
          <button type="submit" class="btn btn-primary">View Hours</button>
          <a href="/hours" class="btn btn-outline">Clear Filter</a>
          
          <div class="quick-filters">
            <button type="button" onclick="setDateRange(7)" class="btn btn-outline">Last 7 days</button>
            <button type="button" onclick="setDateRange(30)" class="btn btn-outline">Last 30 days</button>
            <button type="button" onclick="setDateRange(90)" class="btn btn-outline">Last 90 days</button>
            <button type="button" onclick="setDateRange(365)" class="btn btn-outline">Last year</button>
          </div>
        </form>

        
        <div class="hours-table-group">
          <div class="table-scroll">
            <table class="table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Hours Worked</th>
                </tr>
              </thead>
              <tbody>
                <% if (hoursByDate.length === 0) { %>
                  <tr>
                    <td colspan="2">No hours recorded in this period.</td>
                  </tr>
                <% } else { %>
                  <% hoursByDate.forEach(function(day) { %>
                    <tr>
                      <td><%= day.date %></td>
                      <td><strong><%= day.hoursDisplay %> hours</strong></td>
                    </tr>
                  <% }); %>
                <% } %>
              </tbody>
            </table>
          </div>

        <% 
          var _weekdayOT = 0, _weekend = 0;
          var _ot = 8;
          hoursByDate.forEach(function(day) {
            var parts = day.date.split('/');
            var month = parseInt(parts[0], 10);
            var dayNum = parseInt(parts[1], 10);
            var year = parseInt(parts[2], 10);
            var dow = new Date(year, month - 1, dayNum).getDay();
            var h = typeof day.hours === 'number' ? day.hours : parseFloat(day.hours);
            if (dow >= 1 && dow <= 5) {
              _weekdayOT += Math.max(0, h - _ot);
            } else {
              _weekend += h;
            }
          });
          var _totalExtra = _weekdayOT + _weekend;
          var weekdayDisplay = (typeof weekdayOvertimeHoursDisplay !== 'undefined') ? weekdayOvertimeHoursDisplay : _weekdayOT.toFixed(2);
          var weekendDisplay = (typeof weekendHoursDisplay !== 'undefined') ? weekendHoursDisplay : _weekend.toFixed(2);
          var totalExtraDisplay = (typeof totalExtraHoursDisplay !== 'undefined') ? totalExtraHoursDisplay : _totalExtra.toFixed(2);
          var totalWorkedDisplay = hoursByDate.reduce((sum, day) => sum + parseFloat(day.hours), 0).toFixed(2);
        %>
        <table class="table summary-table">
          <tbody>
            <tr style="background: #f9fafb; font-weight: bold;">
              <td>Total</td>
              <td><%= totalWorkedDisplay %> hours</td>
            </tr>
            <tr style="background: #f9fafb; font-weight: bold;">
              <td>Weekday Overtime</td>
              <td><%= weekdayDisplay %> hours</td>
            </tr>
            <tr style="background: #f9fafb; font-weight: bold;">
              <td>Weekend Hours</td>
              <td><%= weekendDisplay %> hours</td>
            </tr>
            <tr style="background: #eef2ff; font-weight: bold;">
              <td>Total Extra Hours</td>
              <td><%= totalExtraDisplay %> hours</td>
            </tr>
          </tbody>
        </table>
        </div>
      </section>
    </main>

    <script>
      function setDateRange(days) {
        // Get today's date in NY timezone (same as server logic)
        const now = new Date();
        const todayNYStr = now.toLocaleDateString('en-US', { 
          timeZone: 'America/New_York',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
        });
        const [todayMonth, todayDay, todayYear] = todayNYStr.split('/').map(Number);
        const todayNY = new Date(todayYear, todayMonth - 1, todayDay);
        
        // Calculate start date (days ago in NY timezone)
        const startNY = new Date(todayNY);
        startNY.setDate(startNY.getDate() - days);
        
        // Format as YYYY-MM-DD (same format as server expects)
        const formatDate = (date) => {
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          return `${year}-${month}-${day}`;
        };
        
        document.getElementById('startDate').value = formatDate(startNY);
        document.getElementById('endDate').value = formatDate(todayNY);
        
        // Auto-submit the form
        document.querySelector('.date-range-form').submit();
      }
      
      function validateDateRange() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const today = new Date().toISOString().split('T')[0];
        
        if (!startDate || !endDate) {
          alert('Please select both start and end dates.');
          return false;
        }
        
        if (endDate > today) {
          alert('Please select a valid date range. End date cannot be in the future.');
          return false;
        }
        
        if (startDate > endDate) {
          alert('Please select a valid date range. Start date must be before end date.');
          return false;
        }
        
        return true;
      }
      
      // Set max date to today for date inputs
      document.addEventListener('DOMContentLoaded', function() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('startDate').setAttribute('max', today);
        document.getElementById('endDate').setAttribute('max', today);
      });
    </script>
    
  </body>
  <script>
    (function(){
      try { console.log('UI Boot', { route: location.pathname }); } catch(_) {}
      document.addEventListener('keydown', function(e){
        var k = e.key || '';
        if ((k === 'd' || k === 'D') && e.ctrlKey && e.altKey) {
          var levels = ['info','warning','error','off'];
          var cur = localStorage.getItem('debug.level') || 'info';
          var idx = levels.indexOf(cur);
          var next = levels[(idx >= 0 ? idx : 0) + 1 >= levels.length ? 0 : (idx + 1)];
          try { localStorage.setItem('debug.level', next); console.log('Debug level set to', next); } catch(_) {}
        }
      });
    })();
  </script>
  
</html>
