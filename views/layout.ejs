<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= title || 'Timesheet' %></title>
     <script>
       (function() {
         try {
           var saved = localStorage.getItem('theme') || 'light';
           var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
           var resolved = saved === 'system' ? (prefersDark ? 'dark' : 'light') : saved;
           if (resolved !== 'dark' && resolved !== 'light') { resolved = 'light'; }
           if (resolved === 'dark') { document.documentElement.classList.add('dark'); }
         } catch (e) {}
       })();
     </script>
    <link rel="stylesheet" href="/styles.css" />
    <script src="/userMenu.js" defer></script>
    <script src="/clock.js" defer></script>
    <script>
      (function() {
        var Debug = (function(){
          var levelMap = { off: 4, error: 3, warning: 2, info: 1 };
          var level = localStorage.getItem('debug.level') || 'info';
          function shouldLog(type){ var t = type==='error'?3:type==='warning'?2:1; return levelMap[level] <= t || type==='error'; }
          function ts(){ return new Date().toISOString(); }
          function style(type){ if(type==='error') return 'color:#ef4444;font-weight:700'; if(type==='warning') return 'color:#f59e0b;font-weight:700'; return 'color:#2563eb;font-weight:700'; }
          function info(label,data){ if(!shouldLog('info')) return; try { console.log('%c['+ts()+'] INFO '+label, style('info'), data); } catch(_) {} }
          function warning(label,data){ if(!shouldLog('warning')) return; try { console.warn('%c['+ts()+'] WARN '+label, style('warning'), data); } catch(_) {} }
          function error(label,data){ try { console.error('%c['+ts()+'] ERROR '+label, style('error'), data); } catch(_) {} }
          function group(label,type){ if(!shouldLog(type||'info') && type!=='error') return; try { console.groupCollapsed('['+ts()+'] '+label); } catch(_) {} }
          function groupEnd(){ try { console.groupEnd(); } catch(_) {} }
          function setLevel(v){ level = v; localStorage.setItem('debug.level', v); try { console.info('Debug level set to', v); } catch(_) {} }
          var origFetch = window.fetch ? window.fetch.bind(window) : null;
          if(origFetch){ window.fetch = async function(input, init){ var started = performance.now(); var url = typeof input==='string'? input : (input && input.url) || ''; var method = (init && init.method) || 'GET'; group('API Request '+method+' '+url,'info'); info('Request',{ url: url, method: method, headers: (init && init.headers) || {}, body: (init && init.body) }); groupEnd(); try { var res = await origFetch(input, init); var clone = res.clone(); var text; try { text = await clone.text(); } catch(__) { text = '(body unreadable)'; } var headers = {}; try { res.headers && res.headers.forEach(function(v,k){ headers[k]=v; }); } catch(_) {} group('API Response '+method+' '+url,'info'); info('Response',{ status: res.status, ok: res.ok, headers: headers, durationMs: Math.round(performance.now()-started), body: text }); groupEnd(); return res; } catch(e) { error('API Failure',{ url: url, method: method, error: e && e.message, stack: e && e.stack }); throw e; } }; }
          var origXhr = window.XMLHttpRequest; if(origXhr){ var P = origXhr.prototype; var oOpen = P.open; var oSend = P.send; P.open = function(m,u){ this.__m=m; this.__u=u; return oOpen.apply(this, arguments); }; P.send = function(body){ var start = performance.now(); var xhr = this; function done(){ try { group('XHR '+(xhr.__m||'')+' '+(xhr.__u||''),'info'); info('XHR Result',{ status: xhr.status, responseType: xhr.responseType, durationMs: Math.round(performance.now()-start) }); groupEnd(); } catch(_) {} xhr.removeEventListener('loadend', done); } xhr.addEventListener('loadend', done); return oSend.apply(this, arguments); }; }
          window.addEventListener('error', function(e){ error('Unhandled Error',{ message: e.message, stack: (e.error && e.error.stack) ? e.error.stack : (e.filename+':'+e.lineno+':'+e.colno) }); });
          window.addEventListener('unhandledrejection', function(e){ var r = e.reason; error('Unhandled Rejection',{ reason: (r && (r.stack||r.message)) || r }); });
          function perfStart(key){ try { performance.mark(key+'-start'); } catch(_) {} }
          function perfEnd(key){ try { performance.mark(key+'-end'); var m = performance.measure(key, key+'-start', key+'-end'); info('Perf '+key,{ durationMs: Math.round(m.duration) }); } catch(_) {} }
          function setState(name,value){ try { window.APP_STATE = window.APP_STATE || {}; window.APP_STATE[name] = value; } catch(_) {} }
          function getLevel(){ return level; }
          return { info: info, warning: warning, error: error, group: group, groupEnd: groupEnd, setLevel: setLevel, perfStart: perfStart, perfEnd: perfEnd, setState: setState, getLevel: getLevel };
        })();
        window.DEBUG = Debug;
        try { console.log('Boot', { route: location.pathname, debugLevel: Debug.getLevel() }); } catch(_) {}
        document.addEventListener('keydown', function(e){
          var k = e.key || '';
          if ((k === 'd' || k === 'D') && e.ctrlKey && e.altKey) {
            var levels = ['info','warning','error','off'];
            var cur = Debug.getLevel();
            var idx = levels.indexOf(cur);
            var next = levels[(idx >= 0 ? idx : 0) + 1 >= levels.length ? 0 : (idx + 1)];
            Debug.setLevel(next);
          }
        });
      })();
    </script>
  </head>
  <body>
    <header class="topbar">
      <a href="/dashboard" class="brand" aria-label="Dashboard"><%= brand %></a>
      <% if (user) { %>
        <div class="topbar-nav">
          <button onclick="window.history.back()" class="btn btn-nav">‚Üê Back</button>
          <a href="/dashboard" class="btn btn-nav">Home</a>
        </div>
        <div class="topbar-right">
          <div class="user-menu">
            <button type="button" class="user-menu-trigger" id="user-menu-trigger" aria-haspopup="menu" aria-expanded="false" aria-label="User menu">
              <svg viewBox="0 0 24 24" width="24" height="24">
                <circle class="circle" cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"></circle>
                <circle class="head" cx="12" cy="8" r="3" fill="currentColor"></circle>
                <path class="body" d="M12 13 Q 8 13 7 16 Q 12 18 17 16 Q 16 13 12 13" fill="currentColor"></path>
              </svg>
            </button>
            <div class="user-menu-panel" id="user-menu-panel" role="menu" aria-hidden="true">
              <div class="user-menu-header">
                <div class="user-name"><%= user.name %><% if (user.is_admin) { %> (Admin)<% } %></div>
                <% if (typeof user.email !== 'undefined' && user.email) { %>
                  <div class="user-email"><%= user.email %></div>
                <% } %>
              </div>
              <div class="menu-divider" aria-hidden="true"></div>
              <div class="user-menu-actions">
                <div class="user-menu-section">
                  <a href="/export" class="section-label icon-link" role="menuitem" aria-label="Export Timesheet">
                    <svg class="menu-icon" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 256 256" enable-background="new 0 0 256 256" xml:space="preserve" aria-hidden="true">
                      <g><g><path fill="#000000" d="M113.1,208.4H111l-1.8-1.7c-1.8-1.9-1.7-4.2-1.7-5c0.5-14.1,6.8-83.1,80-86.1V93.4c-0.1-1.3-0.1-4.1,1.9-6.3c2.3-2.6,5.9-3.2,10.1-1.3l1,0.4l41.1,44.7c0.8,1,4.3,5.3,4.3,10.5c0,5.3-4.3,9.9-5.2,10.8l-41.2,47.4c-1.1,1.1-3.6,3.4-6.9,3.4c-2.6,0-4.8-1.4-6-3.8c-0.9-1.6-1.3-3.7-1.3-6.5v-26.9c-11.9-0.3-46.5,2.1-66.7,38.9C117.4,207,115.4,208.4,113.1,208.4L113.1,208.4z M183.8,155.5c4.5,0,7.4,0.4,7.5,0.4l4.3,0.6v32.1l37.8-43.5c1.3-1.4,2.5-3.2,2.5-3.9c0-1-1-2.9-1.8-3.8l-36.4-39.6l0,27.7h-5.1c-52.2,0-68.1,35.5-73,59.7C141.5,158.7,170.9,155.5,183.8,155.5L183.8,155.5z"/><path fill="#000000" d="M171.3,213.1c-2.5,0.7-5,1.1-7.7,1.1H49.2c-14.7,0-26.7-11.2-26.7-25.9V68.5c0-14.7,11.9-26.7,26.7-26.7h114.3c0,0,0,0,0,0c0.4,0,0.7,0,1.1,0c0.1,0,0.2,0,0.4,0c0.3,0,0.6,0,0.9,0.1c0.2,0,0.3,0,0.5,0c0.3,0,0.5,0,0.7,0.1c0.2,0,0.4,0,0.5,0.1c0.2,0,0.4,0.1,0.6,0.1c0.3,0,0.7,0.1,1,0.2c0.1,0,0.3,0,0.4,0.1c0.2,0,0.5,0.1,0.7,0.2c0.1,0,0.1,0,0.2,0c0.5,0.1,1,0.3,1.5,0.5h0c5.9,2,10.9,6,14.1,11.2h0c2.4,3.8,3.8,8.2,4,13h12.5v-0.6c0-4.3-0.7-8.5-2.1-12.3h0.2c-5-14.3-18.4-24.7-34.3-25.1c-0.2,0-0.4,0-0.7,0c-0.1,0-0.2,0-0.3,0h-118C26.7,29.3,10,46,10,66.7v122.7c0,20.7,16.7,37.4,37.4,37.4h117.9c11.6,0,22-5.3,28.8-13.6L171.3,213.1L171.3,213.1L171.3,213.1z"/><path fill="#000000" d="M41.3,89.4h108.3v12.5H41.3V89.4z"/><path fill="#000000" d="M41.3,122.4h79.2v12.5H41.3V122.4z"/><path fill="#000000" d="M41.3,154.1h56.5v12.5H41.3V154.1L41.3,154.1z"/></g></g>
                    </svg>
                    <span>Export Timesheet</span>
                  </a>
                </div>
                <div class="user-menu-section">
                  <div class="section-label icon-link" role="presentation">
                    <svg class="theme-icon" viewBox="0 0 24 24" aria-hidden="true">
                      <g class="sun" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                      </g>
                      <g class="moon">
                        <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                      </g>
                    </svg>
                    <span>Theme</span>
                  </div>
                  <div class="theme-options" role="group" aria-label="Theme">
                    <button type="button" class="menu-item" role="menuitemradio" data-theme-option="dark" aria-checked="false">Dark</button>
                    <button type="button" class="menu-item" role="menuitemradio" data-theme-option="light" aria-checked="true">Light</button>
                    <button type="button" class="menu-item" role="menuitemradio" data-theme-option="system" aria-checked="false">System</button>
                  </div>
                </div>
                <div class="menu-divider" aria-hidden="true"></div>
                <form method="post" action="/logout">
                  <button type="submit" class="menu-item icon-link" role="menuitem" aria-label="Log out">
                    <svg class="menu-icon" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 256 256" xml:space="preserve" aria-hidden="true">
                      <g>
                        <path fill="#000000" d="M10,68.1c0-16.6,13.4-30,29.9-30h96.6c16.5,0,29.9,13.5,29.9,30v19.4c0,3.3-2.6,5.9-5.9,5.9c0,0,0,0,0,0 c-3.3,0-5.9-2.7-5.9-5.9c0,0,0,0,0,0V68.1c0-10-8.1-18.1-18.1-18.1H39.9c-10,0-18.1,8.2-18.1,18.1v119.8c0,10,8.1,18.1,18.1,18.1 h96.5c10,0,18.1-8.2,18.1-18.1v-19.4c0-3.3,2.6-5.9,5.9-5.9c0,0,0,0,0,0c3.3,0,5.9,2.7,5.9,5.9c0,0,0,0,0,0v19.4 c0,16.5-13.4,30-29.9,30H39.9c-16.5,0-29.9-13.5-29.9-30V68.1z M195.5,172.6c-2.3-2.3-2.3-6,0-8.3c0,0,0,0,0,0l30.3-30.4H115.2 c-3.3,0-5.9-2.7-5.9-5.9c0,0,0,0,0,0c0-3.3,2.6-5.9,5.9-5.9c0,0,0,0,0,0h110.7l-30.3-30.4c-2.3-2.3-2.3-6,0-8.3c0,0,0,0,0,0 c2.3-2.3,6-2.3,8.3,0c0,0,0,0,0,0l40.4,40.5c2.3,2.3,2.3,6,0,8.3c0,0,0,0,0,0l-40.4,40.5c-1.1,1.1-2.6,1.7-4.2,1.7 C198.2,174.4,196.7,173.8,195.5,172.6L195.5,172.6z"/>
                      </g>
                    </svg>
                    <span>Log out</span>
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
      <% } else { %>
        <div class="topbar-right"></div>
      <% } %>
    </header>

    <main class="container">
      <%- body %>
    </main>
    <script>
      (function() {
        try {
          var state = { user: <%- JSON.stringify(user ? { id: user.id, name: user.name, email: user.email, username: user.username, is_admin: user.is_admin } : null) %>, route: location.pathname, theme: document.documentElement.classList.contains('dark') ? 'dark' : 'light' };
          window.APP_STATE = state;
          window.DEBUG.group('App State','info');
          window.DEBUG.info('State', state);
          window.DEBUG.groupEnd();
        } catch(_) {}
      })();
    </script>
    <script>
      (function(){
        try {
          document.querySelectorAll('.table-wrap').forEach(function(wrap){
            var head = wrap.querySelector('.table-head-scroll');
            var body = wrap.querySelector('.table-body-scroll');
            if (!head || !body) return;
            var s = false;
            body.addEventListener('scroll', function(){ if (s) return; s = true; head.scrollLeft = body.scrollLeft; s = false; });
            head.addEventListener('scroll', function(){ if (s) return; s = true; body.scrollLeft = head.scrollLeft; s = false; });
          });
        } catch(_) {}
      })();
    </script>
  </body>
</html>
