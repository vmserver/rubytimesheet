<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Timesheet</title>
    <script>
      (function() {
        try {
          var saved = localStorage.getItem('theme') || 'light';
          var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
          var resolved = saved === 'system' ? (prefersDark ? 'dark' : 'light') : saved;
          if (resolved !== 'dark' && resolved !== 'light') { resolved = 'light'; }
          if (resolved === 'dark') { document.documentElement.classList.add('dark'); }
        } catch (e) {}
      })();
    </script>
    <link rel="stylesheet" href="/styles.css" />
    <script src="/userMenu.js" defer></script>
    <script src="/clock.js" defer></script>
  </head>
  <body>
    <header class="topbar">
      <a href="/dashboard" class="brand" aria-label="Dashboard"><%= brand %></a>
      <% if (user) { %>
        <div class="topbar-nav">
          <button onclick="window.history.back()" class="btn btn-nav">← Back</button>
          <a href="/dashboard" class="btn btn-nav">Home</a>
        </div>
        <div class="topbar-right">
          <div class="user-menu">
            <button type="button" class="user-menu-trigger" id="user-menu-trigger" aria-haspopup="menu" aria-expanded="false" aria-label="User menu">
              <svg viewBox="0 0 24 24" width="24" height="24">
                <circle class="circle" cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"></circle>
                <circle class="head" cx="12" cy="8" r="3" fill="currentColor"></circle>
                <path class="body" d="M12 13 Q 8 13 7 16 Q 12 18 17 16 Q 16 13 12 13" fill="currentColor"></path>
              </svg>
            </button>
            <div class="user-menu-panel" id="user-menu-panel" role="menu" aria-hidden="true">
              <div class="user-menu-header">
                <div class="user-menu-name"><div class="user-name"><%= user.name %><% if (user.is_admin) { %> (Admin)<% } %></div></div>
                <% if (typeof user.email !== 'undefined' && user.email) { %>
                  <div class="user-email"><%= user.email %></div>
                <% } %>
              </div>
              <div class="menu-divider" aria-hidden="true"></div>
              <div class="user-menu-actions">
                <div class="user-menu-section">
                  <a href="/export" class="section-label icon-link" role="menuitem" aria-label="Export Timesheet">
                    <svg class="menu-icon" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 256 256" enable-background="new 0 0 256 256" xml:space="preserve" aria-hidden="true">
                      <g><g><path fill="#000000" d="M113.1,208.4H111l-1.8-1.7c-1.8-1.9-1.7-4.2-1.7-5c0.5-14.1,6.8-83.1,80-86.1V93.4c-0.1-1.3-0.1-4.1,1.9-6.3c2.3-2.6,5.9-3.2,10.1-1.3l1,0.4l41.1,44.7c0.8,1,4.3,5.3,4.3,10.5c0,5.3-4.3,9.9-5.2,10.8l-41.2,47.4c-1.1,1.1-3.6,3.4-6.9,3.4c-2.6,0-4.8-1.4-6-3.8c-0.9-1.6-1.3-3.7-1.3-6.5v-26.9c-11.9-0.3-46.5,2.1-66.7,38.9C117.4,207,115.4,208.4,113.1,208.4L113.1,208.4z M183.8,155.5c4.5,0,7.4,0.4,7.5,0.4l4.3,0.6v32.1l37.8-43.5c1.3-1.4,2.5-3.2,2.5-3.9c0-1-1-2.9-1.8-3.8l-36.4-39.6l0,27.7h-5.1c-52.2,0-68.1,35.5-73,59.7C141.5,158.7,170.9,155.5,183.8,155.5L183.8,155.5z"/><path fill="#000000" d="M171.3,213.1c-2.5,0.7-5,1.1-7.7,1.1H49.2c-14.7,0-26.7-11.2-26.7-25.9V68.5c0-14.7,11.9-26.7,26.7-26.7h114.3c0,0,0,0,0,0c0.4,0,0.7,0,1.1,0c0.1,0,0.2,0,0.4,0c0.3,0,0.6,0,0.9,0.1c0.2,0,0.3,0,0.5,0c0.3,0,0.5,0,0.7,0.1c0.2,0,0.4,0,0.5,0.1c0.2,0,0.4,0.1,0.6,0.1c0.3,0,0.7,0.1,1,0.2c0.1,0,0.3,0,0.4,0.1c0.2,0,0.5,0.1,0.7,0.2c0.1,0,0.1,0,0.2,0c0.5,0.1,1,0.3,1.5,0.5h0c5.9,2,10.9,6,14.1,11.2h0c2.4,3.8,3.8,8.2,4,13h12.5v-0.6c0-4.3-0.7-8.5-2.1-12.3h0.2c-5-14.3-18.4-24.7-34.3-25.1c-0.2,0-0.4,0-0.7,0c-0.1,0-0.2,0-0.3,0h-118C26.7,29.3,10,46,10,66.7v122.7c0,20.7,16.7,37.4,37.4,37.4h117.9c11.6,0,22-5.3,28.8-13.6L171.3,213.1L171.3,213.1L171.3,213.1z"/><path fill="#000000" d="M41.3,89.4h108.3v12.5H41.3V89.4z"/><path fill="#000000" d="M41.3,122.4h79.2v12.5H41.3V122.4z"/><path fill="#000000" d="M41.3,154.1h56.5v12.5H41.3V154.1L41.3,154.1z"/></g></g>
                    </svg>
                    <span>Export Timesheet</span>
                  </a>
                </div>
                <div class="user-menu-section">
                  <div class="section-label icon-link" role="presentation">
                    <svg class="theme-icon" viewBox="0 0 24 24" aria-hidden="true">
                      <g class="sun" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                      </g>
                      <g class="moon">
                        <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                      </g>
                    </svg>
                    <span>Theme</span>
                  </div>
                  <div class="theme-options" role="group" aria-label="Theme">
                    <button type="button" class="menu-item" role="menuitemradio" data-theme-option="dark" aria-checked="false">Dark</button>
                    <button type="button" class="menu-item" role="menuitemradio" data-theme-option="light" aria-checked="true">Light</button>
                    <button type="button" class="menu-item" role="menuitemradio" data-theme-option="system" aria-checked="false">System</button>
                  </div>
                </div>
                <div class="menu-divider" aria-hidden="true"></div>
                <form method="post" action="/logout">
                  <button type="submit" class="menu-item icon-link" role="menuitem" aria-label="Log out">
                    <svg class="menu-icon" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 256 256" xml:space="preserve" aria-hidden="true">
                      <g>
                        <path fill="#000000" d="M10,68.1c0-16.6,13.4-30,29.9-30h96.6c16.5,0,29.9,13.5,29.9,30v19.4c0,3.3-2.6,5.9-5.9,5.9c0,0,0,0,0,0 c-3.3,0-5.9-2.7-5.9-5.9c0,0,0,0,0,0V68.1c0-10-8.1-18.1-18.1-18.1H39.9c-10,0-18.1,8.2-18.1,18.1v119.8c0,10,8.1,18.1,18.1,18.1 h96.5c10,0,18.1-8.2,18.1-18.1v-19.4c0-3.3,2.6-5.9,5.9-5.9c0,0,0,0,0,0c3.3,0,5.9,2.7,5.9,5.9c0,0,0,0,0,0v19.4 c0,16.5-13.4,30-29.9,30H39.9c-16.5,0-29.9-13.5-29.9-30V68.1z M195.5,172.6c-2.3-2.3-2.3-6,0-8.3c0,0,0,0,0,0l30.3-30.4H115.2 c-3.3,0-5.9-2.7-5.9-5.9c0,0,0,0,0,0c0-3.3,2.6-5.9,5.9-5.9c0,0,0,0,0,0h110.7l-30.3-30.4c-2.3-2.3-2.3-6,0-8.3c0,0,0,0,0,0 c2.3-2.3,6-2.3,8.3,0c0,0,0,0,0,0l40.4,40.5c2.3,2.3,2.3,6,0,8.3c0,0,0,0,0,0l-40.4,40.5c-1.1,1.1-2.6,1.7-4.2,1.7 C198.2,174.4,196.7,173.8,195.5,172.6L195.5,172.6z"/>
                      </g>
                    </svg>
                    <span>Log out</span>
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
      <% } %>
    </header>

    <main class="container dashboard">
      <% if (typeof errorMessage !== 'undefined' && errorMessage) { %>
        <div class="alert"><%= errorMessage %></div>
      <% } %>

      <section class="card">
        <div class="card-header">
          <h1>Hi <%= user.name %>, record your time</h1>
          <div class="clock-pill" id="ny-clock">
            <div class="clock-pill-time">
              <span class="time-main" id="ny-time-main"><%= (nyClock && nyClock.timeMain) ? nyClock.timeMain : '' %></span>
              <span class="time-ampm" id="ny-time-ampm"><%= (nyClock && nyClock.ampm) ? nyClock.ampm : '' %></span>
            </div>
            <span class="clock-divider" aria-hidden="true"></span>
            <div class="clock-pill-date">
              <span class="date-text" id="ny-date-full"><%= (nyClock && nyClock.dateFull) ? nyClock.dateFull : '' %></span>
            </div>
          </div>
        </div>
        <% if (typeof isPunchedIn !== 'undefined' && isPunchedIn) { %>
          <p class="status-message status-in">✓ Currently punched in</p>
        <% } else { %>
          <p class="status-message status-out">Not punched in</p>
        <% } %>
        <% if (typeof isOnBreak !== 'undefined' && isOnBreak) { %>
          <p class="status-message status-break">⏸ On break</p>
        <% } %>
        <div class="hours-callout">
          <span class="label">Today's Hours:</span>
          <span class="value"><%= typeof todayHours !== 'undefined' ? todayHours : '0.00' %> hours</span>
        </div>

        <div class="button-row punch-controls">
          <form method="post" action="/punch/in">
            <button type="submit" class="btn btn-success" <% if (typeof isPunchedIn !== 'undefined' && isPunchedIn) { %>disabled<% } %>>Punch In</button>
          </form>
          <form method="post" action="/punch/out">
            <button type="submit" class="btn btn-danger" <% if ((typeof isPunchedIn === 'undefined' || !isPunchedIn) || (typeof isOnBreak !== 'undefined' && isOnBreak)) { %>disabled<% } %>>Punch Out</button>
          </form>
          <form method="post" action="/punch/break_start">
            <button
              type="submit"
              class="btn btn-secondary"
              <% if (typeof isPunchedIn === 'undefined' || !isPunchedIn || (typeof isOnBreak !== 'undefined' && isOnBreak)) { %>disabled<% } %>
            >
              Start Break
            </button>
          </form>
          <form method="post" action="/punch/break_end">
            <button
              type="submit"
              class="btn btn-secondary"
              <% if (typeof isOnBreak === 'undefined' || !isOnBreak) { %>disabled<% } %>
            >
              End Break
            </button>
          </form>
        </div>
      </section>

      <section class="card recent-activity">
        <div class="card-header">
          <h2>Recent activity</h2>
          <a href="/hours" class="btn btn-outline">View Previous Days</a>
        </div>
        <div class="table-scroll">
          <table class="table">
            <thead>
              <tr>
                <th>When</th>
                <th>Type</th>
              </tr>
            </thead>
            <tbody>
              <% if (punches.length === 0) { %>
                <tr><td colspan="2">No punches yet.</td></tr>
              <% } else { %>
                <% punches.forEach(function(p) { %>
                  <tr>
                    <td><%= toLocalString(p.punched_at) %></td>
                    <td><%= p.punch_type %></td>
                  </tr>
                <% }); %>
              <% } %>
            </tbody>
          </table>
        </div>
      </section>

      <% if (user.is_admin) { %>
        <section class="card admin-tools">
          <h2>Admin tools</h2>
          <div class="button-row">
            <a href="/admin/employees" class="btn btn-outline">Manage Employees</a>
            <a href="/admin/punches" class="btn btn-outline">View Recent Punches</a>
            <a href="/admin/export" class="btn btn-outline">Export Timesheet</a>
            <a href="/admin/hours" class="btn btn-outline">Previous Days (All)</a>
          </div>
        </section>
      <% } %>
    </main>
  </body>
  
  </html>
