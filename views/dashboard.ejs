<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Timesheet</title>
    <script>
      (function() {
        try {
          var saved = localStorage.getItem('theme') || 'light';
          var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
          var resolved = saved === 'system' ? (prefersDark ? 'dark' : 'light') : saved;
          if (resolved !== 'dark' && resolved !== 'light') { resolved = 'light'; }
          if (resolved === 'dark') { document.documentElement.classList.add('dark'); }
        } catch (e) {}
      })();
    </script>
    <link rel="stylesheet" href="/styles.css" />
    <script src="/userMenu.js" defer></script>
  </head>
  <body>
    <header class="topbar">
      <div class="brand"><%= brand %></div>
      <% if (user) { %>
        <div class="topbar-nav">
          <button onclick="window.history.back()" class="btn btn-nav">← Back</button>
          <a href="/dashboard" class="btn btn-nav">Home</a>
        </div>
        <div class="topbar-right">
          <div class="user-menu">
            <button type="button" class="user-menu-trigger" id="user-menu-trigger" aria-haspopup="menu" aria-expanded="false" aria-label="User menu">
              <svg viewBox="0 0 24 24" width="24" height="24">
                <circle class="circle" cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"></circle>
                <circle class="head" cx="12" cy="8" r="3" fill="currentColor"></circle>
                <path class="body" d="M12 13 Q 8 13 7 16 Q 12 18 17 16 Q 16 13 12 13" fill="currentColor"></path>
              </svg>
            </button>
            <div class="user-menu-panel" id="user-menu-panel" role="menu" aria-hidden="true">
              <div class="user-menu-header">
                <div class="user-name"><%= user.name %><% if (user.is_admin) { %> (Admin)<% } %></div>
                <% if (typeof user.email !== 'undefined' && user.email) { %>
                  <div class="user-email"><%= user.email %></div>
                <% } %>
              </div>
              <div class="user-menu-actions">
                <div class="user-menu-section">
                  <div class="section-label">Theme</div>
                  <div class="theme-options" role="group" aria-label="Theme">
                    <button type="button" class="menu-item" role="menuitemradio" data-theme-option="dark" aria-checked="false">Dark</button>
                    <button type="button" class="menu-item" role="menuitemradio" data-theme-option="light" aria-checked="true">Light</button>
                    <button type="button" class="menu-item" role="menuitemradio" data-theme-option="system" aria-checked="false">System</button>
                  </div>
                </div>
                <div class="menu-divider" aria-hidden="true"></div>
                <form method="post" action="/logout">
                  <button type="submit" class="menu-item" role="menuitem">Log out</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      <% } %>
    </header>

    <main class="container dashboard">
      <% if (typeof errorMessage !== 'undefined' && errorMessage) { %>
        <div class="alert"><%= errorMessage %></div>
      <% } %>

      <section class="card">
        <div class="card-header">
          <h1>Hi <%= user.name %>, record your time</h1>
          <div class="clock-pill" id="ny-clock">
            <div class="clock-pill-time">
              <span class="time-main" id="ny-time-main"></span>
              <span class="time-ampm" id="ny-time-ampm"></span>
            </div>
            <span class="clock-divider" aria-hidden="true"></span>
            <div class="clock-pill-date">
              <span class="date-text" id="ny-date-full"></span>
            </div>
          </div>
        </div>
        <% if (typeof isPunchedIn !== 'undefined' && isPunchedIn) { %>
          <p class="status-message status-in">✓ Currently punched in</p>
        <% } else { %>
          <p class="status-message status-out">Not punched in</p>
        <% } %>
        <% if (typeof isOnBreak !== 'undefined' && isOnBreak) { %>
          <p class="status-message status-break">⏸ On break</p>
        <% } %>
        <div class="hours-callout">
          <span class="label">Today's Hours:</span>
          <span class="value"><%= typeof todayHours !== 'undefined' ? todayHours : '0.00' %> hours</span>
        </div>

        <div class="button-row punch-controls">
          <form method="post" action="/punch/in">
            <button type="submit" class="btn btn-success" <% if (typeof isPunchedIn !== 'undefined' && isPunchedIn) { %>disabled<% } %>>Punch In</button>
          </form>
          <form method="post" action="/punch/out">
            <button type="submit" class="btn btn-danger" <% if ((typeof isPunchedIn === 'undefined' || !isPunchedIn) || (typeof isOnBreak !== 'undefined' && isOnBreak)) { %>disabled<% } %>>Punch Out</button>
          </form>
          <form method="post" action="/punch/break_start">
            <button
              type="submit"
              class="btn btn-secondary"
              <% if (typeof isPunchedIn === 'undefined' || !isPunchedIn || (typeof isOnBreak !== 'undefined' && isOnBreak)) { %>disabled<% } %>
            >
              Start Break
            </button>
          </form>
          <form method="post" action="/punch/break_end">
            <button
              type="submit"
              class="btn btn-secondary"
              <% if (typeof isOnBreak === 'undefined' || !isOnBreak) { %>disabled<% } %>
            >
              End Break
            </button>
          </form>
        </div>
      </section>

      <section class="card recent-activity">
        <div class="card-header">
          <h2>Recent activity</h2>
          <a href="/hours" class="btn btn-outline">View Previous Days</a>
        </div>
        <div class="table-scroll">
        <table class="table">
          <thead>
            <tr>
              <th>When</th>
              <th>Type</th>
            </tr>
          </thead>
          <tbody>
            <% if (punches.length === 0) { %>
              <tr><td colspan="2">No punches yet.</td></tr>
            <% } else { %>
              <% punches.forEach(function(p) { %>
                <tr>
                  <td><%= toLocalString(p.punched_at) %></td>
                  <td><%= p.punch_type %></td>
                </tr>
              <% }); %>
            <% } %>
          </tbody>
        </table>
        </div>
      </section>

      <% if (user.is_admin) { %>
        <section class="card admin-tools">
          <h2>Admin tools</h2>
          <div class="button-row">
            <a href="/admin/employees" class="btn btn-outline">Manage Employees</a>
            <a href="/admin/punches" class="btn btn-outline">View Recent Punches</a>
            <a href="/admin/export" class="btn btn-outline">Export Timesheet</a>
          </div>
        </section>
      <% } %>
    </main>
  </body>
  <script>
    (function() {
      var tMain = document.getElementById('ny-time-main');
      var tAmPm = document.getElementById('ny-time-ampm');
      var dText = document.getElementById('ny-date-full');
      function tick() {
        var now = new Date();
        var parts = new Intl.DateTimeFormat('en-US', {
          timeZone: 'America/New_York',
          hour12: true,
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        }).formatToParts(now);
        var hh = parts.find(p => p.type === 'hour')?.value || '';
        var mm = parts.find(p => p.type === 'minute')?.value || '';
        var ss = parts.find(p => p.type === 'second')?.value || '';
        var dp = parts.find(p => p.type === 'dayPeriod')?.value || '';
        if (tMain) tMain.textContent = hh + ':' + mm + ':' + ss;
        if (tAmPm) tAmPm.textContent = dp ? dp.toUpperCase() : '';
        var dparts = new Intl.DateTimeFormat('en-US', {
          timeZone: 'America/New_York',
          month: 'short',
          day: '2-digit',
          year: 'numeric'
        }).formatToParts(now);
        var mon = dparts.find(p => p.type === 'month')?.value || '';
        var day = dparts.find(p => p.type === 'day')?.value || '';
        var yr = dparts.find(p => p.type === 'year')?.value || '';
        if (dText) dText.textContent = mon + ' ' + day + ' ' + yr;
      }
      tick();
      setInterval(tick, 1000);
    })();
  </script>
  
</html>
